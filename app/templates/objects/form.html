{% extends "base.html" %}
{% block content %}
  <h2 class="text-lg font-semibold mb-4">{{ 'Edit' if item else 'New' }} Object</h2>
  <form method="post" enctype="multipart/form-data" action="{{ '/objects/' + item.id if item else '/objects' }}" class="space-y-3">
    {% if item %}
      <div class="text-sm text-gray-700">ID: <span class="font-mono">{{ item.id }}</span></div>
    {% else %}
      <div class="text-sm text-gray-600">ID will be auto-generated (5-digit).</div>
    {% endif %}
    {% if item and item.tags %}
      <div class="flex flex-wrap gap-1">
        {% for tid in item.tags %}
          <span class="px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-900 border">{{ tags_by_id.get(tid, tid) }}</span>
        {% endfor %}
      </div>
    {% endif %}
    <div>
      <label class="block text-sm">Name</label>
      <input name="name" value="{{ item.name if item else '' }}" class="border rounded px-3 py-2 w-full" required />
    </div>
    <div>
      <label class="block text-sm">Description</label>
      <textarea name="description" class="border rounded px-3 py-2 w-full" rows="3">{{ item.description if item else '' }}</textarea>
    </div>
    <div>
      <label class="block text-sm">Images (comma separated URLs)</label>
      <input name="images" value="{{ ','.join(item.images) if item and item.images else '' }}" class="border rounded px-3 py-2 w-full" />
    </div>
    <div>
      <label class="block text-sm">Photos (drag & drop or select)</label>
      <div id="dropzone" class="border-dashed border-2 rounded p-4 text-center text-sm text-gray-600">Drop images here or click to select</div>
      <input id="photos" type="file" name="images_photo" accept="image/*" multiple class="hidden" />
      {% if item and item.images_photo %}
        <div class="mt-2 text-xs text-gray-600">Existing photos (select to remove):</div>
        <div class="mt-1 grid grid-cols-6 gap-2">
          {% for ph in item.images_photo %}
            <div>
              <img src="{{ ph }}" alt="photo" class="h-16 w-full object-cover rounded border" />
              <label class="flex items-center gap-1 mt-1 text-xs"><input type="checkbox" name="remove_photo" value="{{ loop.index0 }}" /> Remove</label>
            </div>
          {% endfor %}
        </div>
      {% endif %}
      <div id="preview" class="mt-2 grid grid-cols-6 gap-2"></div>
    </div>
    <div>
      <label class="block text-sm">Tags (multi-select)</label>
      <select name="tags" multiple class="border rounded px-3 py-2 w-full h-28">
        {% for t in tags %}
          <option value="{{ t.id }}" {% if item and item.tags and (t.id in item.tags) %}selected{% endif %}>{{ t.name }}</option>
        {% endfor %}
      </select>
      <div class="mt-1 text-xs text-gray-600">Hold Cmd/Ctrl to select multiple tags.</div>
      <div class="mt-1"><a class="text-blue-700 text-xs" href="/tags" target="_blank">Manage tags</a></div>
    </div>
    <div>
      <label class="block text-sm">Save Place</label>
      <select name="place_id" class="border rounded px-3 py-2 w-full">
        <option value="">(none)</option>
        {% for p in places %}
          <option value="{{ p.id }}" {% if item and item.place_id == p.id %}selected{% endif %}>{{ p.name }} ({{ p.id }})</option>
        {% endfor %}
      </select>
      <div class="mt-1 text-xs text-gray-600">Put time updates automatically when moved.</div>
    </div>
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
  </form>
  <script>
    const dz = document.getElementById('dropzone');
    const input = document.getElementById('photos');
    dz.addEventListener('click', () => input.click());
    ;['dragenter','dragover'].forEach(evt => dz.addEventListener(evt, e => { e.preventDefault(); dz.classList.add('bg-gray-50'); }));
    ;['dragleave','drop'].forEach(evt => dz.addEventListener(evt, e => { e.preventDefault(); dz.classList.remove('bg-gray-50'); }));
    dz.addEventListener('drop', e => { input.files = e.dataTransfer.files; renderPreviews(); });
    input.addEventListener('change', renderPreviews);
    function renderPreviews() {
      const holder = document.getElementById('preview');
      holder.innerHTML = '';
      const files = input.files ? Array.from(input.files) : [];
      files.forEach(f => {
        const url = URL.createObjectURL(f);
        const img = document.createElement('img');
        img.src = url; img.className = 'h-16 w-full object-cover rounded border';
        holder.appendChild(img);
      });
    }
  </script>
{% endblock %}